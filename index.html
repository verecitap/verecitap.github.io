<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador GPS KidsGuard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #F2F4F8; }
        .untrm-blue { background-color: #1B396A; }
        .untrm-text { color: #1B396A; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- CABECERA -->
    <div class="w-full untrm-blue text-white p-6 rounded-b-[30px] shadow-lg text-center">
        <i class="fa-solid fa-satellite-dish text-4xl mb-2"></i>
        <h1 class="text-2xl font-bold">Simulador GPS</h1>
        <p class="text-sm opacity-80">Convierte este celular en un Tracker</p>
    </div>

    <!-- CONTENIDO -->
    <div class="w-full max-w-md p-6 -mt-4">
        
        <!-- TARJETA DE CONTROL -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ID del Dispositivo</label>
            <div class="flex items-center border-b-2 border-gray-200 py-2 mb-6">
                <input id="deviceId" type="text" value="hijo_1" 
                    class="appearance-none bg-transparent border-none w-full text-gray-700 mr-3 py-1 px-2 leading-tight focus:outline-none font-bold text-lg" 
                    placeholder="Ej: hijo_1">
            </div>

            <button id="btnToggle" onclick="toggleTracking()" 
                class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl transition duration-300 flex items-center justify-center gap-2 shadow-md">
                <i class="fa-solid fa-play"></i> INICIAR RASTREO
            </button>
            
            <p id="statusMsg" class="text-center text-xs text-gray-400 mt-3">GPS Inactivo</p>
        </div>

        <!-- TARJETA DE DATOS EN VIVO -->
        <div id="dataCard" class="bg-white rounded-2xl shadow-lg p-6 hidden">
            <h3 class="untrm-text font-bold text-lg mb-4 border-b pb-2">Datos en Tiempo Real</h3>
            
            <div class="grid grid-cols-2 gap-4">
                <!-- Latitud -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500">Latitud</p>
                    <p id="valLat" class="font-mono font-bold text-gray-800">--</p>
                </div>
                <!-- Longitud -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500">Longitud</p>
                    <p id="valLng" class="font-mono font-bold text-gray-800">--</p>
                </div>
                <!-- Velocidad -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500">Velocidad</p>
                    <p id="valSpeed" class="font-bold text-blue-600">0 km/h</p>
                </div>
                <!-- Batería -->
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500">Batería</p>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-battery-full text-green-500"></i>
                        <p id="valBat" class="font-bold text-green-600">--%</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center">
                <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full animate-pulse">
                    <i class="fa-solid fa-wifi"></i> Enviando a Firebase...
                </span>
            </div>
        </div>
    </div>

    <!-- LOGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqexd82EjTNRRXIZJNBNjEHeKbNXoDh1Y",
            authDomain: "kidsguard-tesis-2eed4.firebaseapp.com",
            databaseURL: "https://kidsguard-tesis-2eed4-default-rtdb.firebaseio.com",
            projectId: "kidsguard-tesis-2eed4",
            storageBucket: "kidsguard-tesis-2eed4.firebasestorage.app",
            messagingSenderId: "907181749548",
            appId: "1:907181749548:web:df95f678edbcb00406e889"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let watchId = null;
        let intervalId = null; // Para el reloj de 5 segundos
        let isTracking = false;
        
        // Variables para almacenar la última posición conocida
        let lastLat = null;
        let lastLng = null;
        let lastSpeed = 0;
        let hasLocation = false; // Para saber si ya tenemos al menos una coordenada

        const btn = document.getElementById('btnToggle');
        const status = document.getElementById('statusMsg');
        const dataCard = document.getElementById('dataCard');

        window.toggleTracking = function() {
            if (!isTracking) {
                startTracking();
            } else {
                stopTracking();
            }
        };

        function startTracking() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta GPS");
                return;
            }

            isTracking = true;
            btn.innerHTML = '<i class="fa-solid fa-stop"></i> DETENER RASTREO';
            btn.classList.remove('bg-blue-500', 'hover:bg-blue-700');
            btn.classList.add('bg-red-500', 'hover:bg-red-700', 'pulse');
            status.textContent = "Iniciando sistemas...";
            status.classList.add('text-green-500');
            dataCard.classList.remove('hidden');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            // 1. Iniciamos el GPS (Solo actualiza variables locales)
            watchId = navigator.geolocation.watchPosition(updateLocalData, error, options);

            // 2. Iniciamos el RELOJ (Envía a Firebase cada 5s SIEMPRE)
            intervalId = setInterval(sendToFirebase, 5000);
        }

        function stopTracking() {
            isTracking = false;
            navigator.geolocation.clearWatch(watchId);
            clearInterval(intervalId); // Detenemos el reloj
            
            btn.innerHTML = '<i class="fa-solid fa-play"></i> INICIAR RASTREO';
            btn.classList.add('bg-blue-500', 'hover:bg-blue-700');
            btn.classList.remove('bg-red-500', 'hover:bg-red-700', 'pulse');
            status.textContent = "Rastreo detenido";
            status.classList.remove('text-green-500');
        }

        // Función A: Se ejecuta cada vez que el GPS detecta algo (puede ser rápido o lento)
        function updateLocalData(pos) {
            const crd = pos.coords;
            
            // Guardamos en variables globales
            lastLat = crd.latitude;
            lastLng = crd.longitude;
            lastSpeed = (crd.speed || 0) * 3.6; // Convertir a km/h
            hasLocation = true; // Ya tenemos datos válidos

            // Actualizamos la pantalla visualmente (UX)
            document.getElementById('valLat').innerText = lastLat.toFixed(6);
            document.getElementById('valLng').innerText = lastLng.toFixed(6);
            document.getElementById('valSpeed').innerText = lastSpeed.toFixed(1) + " km/h";
        }

        // Función B: Se ejecuta CADA 5 SEGUNDOS RELIGIOSAMENTE
        async function sendToFirebase() {
            if (!hasLocation) {
                status.textContent = "Esperando señal GPS para primer envío...";
                return; // No enviamos nada si aún no hay coordenadas
            }

            const deviceId = document.getElementById('deviceId').value;
            
            // Batería (Intento obtenerla en cada ciclo de envío)
            let bateriaNivel = 0;
            if (navigator.getBattery) {
                try {
                    const battery = await navigator.getBattery();
                    bateriaNivel = Math.round(battery.level * 100);
                } catch (e) { console.log("Batería no disponible"); }
            }
            // En iOS la batería suele fallar o dar null, enviamos 0 o lo que se pueda
            document.getElementById('valBat').innerText = (bateriaNivel > 0 ? bateriaNivel : "N/A") + "%";

            // Preparar datos
            const updates = {};
            const path = `estudiantes/${deviceId}`;
            
            updates[path + "/lat"] = lastLat;
            updates[path + "/lng"] = lastLng;
            //updates[path + "/bateria"] = bateriaNivel;

            status.textContent = `Enviando... (${new Date().toLocaleTimeString()})`;

            update(ref(db), updates)
                .then(() => {
                    console.log("Ping a Firebase (5s)");
                    status.textContent = `Último envío: ${new Date().toLocaleTimeString()}`;
                })
                .catch((error) => console.error("Error Firebase: ", error));
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            // Solo mostramos error, no detenemos el reloj (intentará enviar datos viejos si los hay)
            status.textContent = "Señal GPS débil: " + err.message;
            status.classList.add('text-red-500');
        }
    </script>
</body>
</html>

